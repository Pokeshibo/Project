<!DOCTYPE html>
<html>
<head>
    <title>Tital Chat</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 h-screen">
    <div class="flex h-full">
        <!-- Sidebar -->
        <div class="w-1/4 bg-white border-r">
            <div class="p-4 bg-blue-600 text-white">
                <h1 class="text-xl font-bold">Tital Chat</h1>
                <p class="text-sm">Logged in as: {{ current_user.username }}</p>
            </div>
            
            <div class="p-4">
                <h2 class="text-lg font-semibold mb-4">Online Users</h2>
                <div id="online-users" class="space-y-2">
                    {% for user in online_users %}
                    <div class="flex items-center p-2 hover:bg-gray-100 cursor-pointer user-item" 
                         data-user-id="{{ user.id }}">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                        {{ user.username }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Messages Container -->
            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Messages will load here -->
            </div>

            <!-- Message Input -->
            <div class="p-4 border-t bg-white">
                <div class="flex gap-2">
                    <input type="text" id="message-input" 
                           class="flex-1 p-2 border rounded-lg" 
                           placeholder="Type your message...">
                    <button onclick="sendMessage()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <!-- chat.html में नया JavaScript कोड -->
<script>
    let currentMessages = [];
    let currentReceiver = null;

    // Initialize Socket.IO
    const socket = io();
    
    // Connect to personal room
    socket.on('connect', () => {
        socket.emit('join', { user_id: '{{ current_user.id }}' });
    });

    // Load messages when receiver selected
    async function loadChatHistory(receiverId) {
        currentReceiver = receiverId;
        try {
            const response = await fetch(`/api/messages/${receiverId}`);
            currentMessages = await response.json();
            renderMessages();
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    // Render messages from database
    function renderMessages() {
        const container = document.getElementById('messages');
        container.innerHTML = '';
        
        currentMessages.forEach(msg => {
            const div = document.createElement('div');
            div.className = msg.is_mine ? 
                'bg-green-100 ml-auto' : 'bg-blue-100';
            div.innerHTML = `
                <div class="p-3 rounded-lg max-w-md mb-2">
                    <p>${msg.content}</p>
                    <div class="flex items-center justify-between mt-1">
                        <span class="text-xs text-gray-500">${msg.timestamp}</span>
                        ${msg.is_mine ? 
                            `<span class="text-xs ${msg.is_delivered ? 'text-blue-500' : 'text-gray-400'}">
                                ${msg.is_delivered ? '✓✓' : '✓'}
                            </span>` : ''
                        }
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
    }

    // Handle new messages
    socket.on('new_message', (msg) => {
        if(msg.sender_id == currentReceiver) {
            currentMessages.push({
                ...msg,
                is_mine: false
            });
            renderMessages();
            // Send delivery confirmation
            socket.emit('message_delivered', { 
                message_id: msg.id 
            });
        }
    });

    // Send message with temporary ID
    async function sendMessage() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        if(!content || !currentReceiver) return;

        const tempId = Date.now();
        const tempMsg = {
            temp_id: tempId,
            content: content,
            is_mine: true,
            timestamp: new Date().toLocaleTimeString(),
            is_delivered: false
        };

        // Add temporary message
        currentMessages.push(tempMsg);
        renderMessages();
        input.value = '';

        try {
            await socket.emitWithAck('send_message', {
                receiver_id: currentReceiver,
                content: content,
                temp_id: tempId
            });
        } catch (error) {
            alert('Message failed to send: ' + error);
            // Remove temporary message on error
            currentMessages = currentMessages.filter(m => m.temp_id !== tempId);
            renderMessages();
        }
    }

    // Handle message sent confirmation
    socket.on('message_sent', (data) => {
        const index = currentMessages.findIndex(m => m.temp_id === data.temp_id);
        if(index > -1) {
            currentMessages[index].id = data.message_id;
            renderMessages();
        }
    });

    // Handle delivery confirmation
    socket.on('delivery_confirmation', (data) => {
        const msg = currentMessages.find(m => m.id === data.message_id);
        if(msg) {
            msg.is_delivered = true;
            renderMessages();
        }
    });
</script>
</body>
</html>
